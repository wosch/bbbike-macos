#!/bin/sh
# Copyright (c) Wolfram Schneider, Aug 2008
#
# bbbike - a wrapper for the perl/tk program BBBike.
#
# BBBike is a route-finder for cyclists in Berlin and Brandenburg
# see http://www.bbbike.de
#
# $Id: bbbike,v 1.56 2009/04/18 10:56:01 wosch Exp $
##################################################################################

# BBBike version
bbbike_version="BBBike-3.17-devel"

# BBBike options
additional_layers="--sehenswuerdigkeiten --rbahn"
advanced_mode=	#"--advanced"
: ${update_data_osm="YES"}


##################################################################################
# perl version
perl_version="5.10.0"

# $0 may contain spaces: /Volumes/bbbike 1/BBBike/bbbike
dir=`dirname "$0"`

# perl/TK binary installation for perl-5.10.0
perl_home="$dir"/.perl-$perl_version

DYLD_LIBRARY_PATH="$perl_home/lib/5.10.0/darwin-thread-multi-2level/CORE"
export DYLD_LIBRARY_PATH


##################################################################################
case `sysctl -n hw.machine` in
        i386) ;;
        * ) banner '.'; echo "Wrong architecture, only MacOS/Intel is supported"; exit 1 ;;
esac
case `sw_vers -productVersion` in
        10.[5-9].* ) ;;
        * ) banner '.'; echo "Wrong MacOS release, only 10.5.X or higher is supported"; exit 1 ;;
esac

datadir=data

city=`basename "$0"`;
if [ $city = "bbbike" ]; then
	datadir=data
	( # update of original BBBike ./data 
	  set -e
	  tmp=`mktemp -t bbbike`
	  sleep 30
	  cd `dirname $0` && ./.update-data-osm "$dir/.$bbbike_version/data-osm/data.tbz" 
	  if [ "$dir/.$bbbike_version/data-osm/data.tbz" -nt $tmp ]; then
	    cd "$dir/.$bbbike_version/data-osm"
	    bzip2 -t data.tbz
	    bzcat data.tbz | tar xf -
	    rm -rf ../data.old
	    mv -f ../data ../data.old || true
	    mv data ..
	  fi
	  rm -f $tmp
	) &
elif [ -d "$dir/.$bbbike_version/data-osm/$city" ]; then
	datadir=data-osm/$city
elif [ -f "$dir/.$bbbike_version/data-osm/$city.tbz" ]; then
	datadir=data-osm/$city
	if [ "$update_data_osm" = "YES" ]; then
		( cd `dirname $0` && ./.update-data-osm "$dir/.$bbbike_version/data-osm/$city.tbz" & )
	fi
else
	echo "Unknown city: $city"
	exit 1
fi


# Languate is German by default
export LANG=de_DE.UTF-8;

# start english version of BBBike
english_cities="$dir/.english_cities"
if egrep -q "^$city$" "$english_cities"; then
	export LANG=en_US.UTF-8
fi

#
# support compressed bbbike data, save ca. 200MB disk space
#
datadir_opt="$dir/.$bbbike_version/$datadir"
tmpdir=""

if [ -f "$datadir_opt.tbz" ]; then
	_city=`basename "$datadir_opt"`	
	tmpdir=`mktemp -d ${TMPDIR-"/tmp"}/bbbike.XXXXXXXXX` || exit 2
	bzcat "$datadir_opt.tbz" | ( cd $tmpdir && tar xf - )
	datadir_opt=$tmpdir/${_city}

	trap 'test -n "$tmpdir" && rm -rf $tmpdir' 0 15 3 5
fi

##################################################################################

"$perl_home"/bin/perl \
	-I"$perl_home"/lib/$perl_version/darwin-thread-multi-2level \
     	-I"$perl_home"/lib/$perl_version \
	-I"$perl_home"/lib/site_perl/$perl_version/darwin-thread-multi-2level \
	-I"$perl_home"/lib/site_perl/$perl_version \
   "$dir"/.$bbbike_version/bbbike \
	-datadir "$datadir_opt" \
	$additional_layers $advanced_mode "$@"

