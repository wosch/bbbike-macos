#!/usr/local/bin/perl 
# -*- perl -*-

use IO::File;

use strict;
use warnings;

use vars qw($VERSION);
$VERSION = 0.1;

use Getopt::Long;

my $debug = 1;    # 0: quiet, 1: normal, 2: verbose

sub usage () {
    <<EOF;
usage: $0 [--debug={0..2}] [options] city

--debug=0..2	  debug option
--lang
--coord
--centerdelta
EOF
}

my $lang;
my $coord;
my $centerdelta;

GetOptions(
    "debug=i" => \$debug,
    "lang"    => \$lang,
    "coord"   => \$coord,
    "centerdelta"   => \$centerdelta,
) or die usage;

my $city = shift or die &usage;
$city =~ s/-(convert|download)$//;

my $db = $0;

$db =~ s,/+[^/]+$,/../misc/cities.csv,;
my %hash;

my $fh = new IO::File $db, "r" or die "open: $!\n";
while (<$fh>) {
    next if /^\s*#/;
    chomp;

    my ( $city, $name, $lang, $area, $coord ) = split(/:/);
    $hash{$city} = {
        city  => $city,
        name  => $name,
        lang  => $lang,
        area  => $area,
        coord => $coord
    };
}
close $fh;

#use Data::Dumper; print Dumper( \%hash );
if ( exists $hash{$city} ) {
    if ($lang) {
        print $hash{$city}->{lang} ? $hash{$city}->{lang} : "de";
        print "\n";
    }
    elsif ($coord) {
        print $hash{$city}->{coord}, "\n";
    }
    elsif ($centerdelta) {
        my ($x1, $y1, $x2, $y2) = split(/\s+/, $hash{$city}->{coord});
	print "$x1,$y1\n";
    }
    else {
        warn "unknown directive\n";
        die &usage;
    }
}
else {
    warn "Unknown city: $city\n";
    &usage;
}
